<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wunderschöner QR-Code-Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        h1 {
            margin-bottom: 20px;
        }

        #qr-reader-container {
            position: relative;
            width: 90vw;
            max-width: 500px;
            height: 90vw;
            max-height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            background-color: #34495e;
        }

        #qr-reader {
            width: 100%;
            height: 100%;
            border: none; /* Entfernt den Standardrahmen der Bibliothek */
        }
        
        /* Versteckt den Info-Text der Bibliothek */
        #qr-reader__dashboard_section_csr > div {
             display: none;
        }


        #qr-box-overlay {
            position: absolute;
            border: 4px solid #f1c40f;
            box-shadow: 0 0 25px #f1c40f, inset 0 0 25px #f1c40f;
            display: none;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            pointer-events: none; /* Stellt sicher, dass die Überlagerung nicht klickbar ist */
            border-radius: 8px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>

    <h1>QR-Code-Scanner</h1>
    <div id="qr-reader-container">
        <div id="qr-reader"></div>
        <div id="qr-box-overlay"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const qrReaderElement = document.getElementById('qr-reader');
            const qrBoxOverlay = document.getElementById('qr-box-overlay');
            let lastScanResult = null;
            let lastScanTime = 0;
            const cooldown = 500; // Millisekunden

            // Callback bei erfolgreichem Scan
            function onScanSuccess(decodedText, decodedResult) {
                // Verhindert mehrfaches Auslösen für denselben Code
                if (decodedText === lastScanResult) {
                    return;
                }

                lastScanResult = decodedText;
                lastScanTime = Date.now();
                
                // Weiterleitung zur gescannten URL, wenn es eine ist
                if (decodedText.startsWith('http')) {
                    // Kurze Verzögerung, damit der Benutzer den Rahmen sieht
                    setTimeout(() => {
                        window.location.href = decodedText;
                    }, 500);
                } else {
                    alert(`Gescannter Code: ${decodedText}`);
                }


                // Positioniere den animierten Rahmen
                // Die Koordinaten sind möglicherweise nicht in allen Browsern verfügbar
                if (decodedResult.result && decodedResult.result.points) {
                    const points = decodedResult.result.points;

                    const xCoords = points.map(p => p.x);
                    const yCoords = points.map(p => p.y);
                    
                    const xMin = Math.min(...xCoords);
                    const yMin = Math.min(...yCoords);
                    const xMax = Math.max(...xCoords);
                    const yMax = Math.max(...yCoords);

                    const video = qrReaderElement.querySelector('video');
                    if (video) {
                        const videoRect = video.getBoundingClientRect();
                        const containerRect = qrReaderElement.getBoundingClientRect();

                        // Berechne die Skalierungsfaktoren zwischen der tatsächlichen Videoauflösung und der angezeigten Größe
                        const scaleX = videoRect.width / video.videoWidth;
                        const scaleY = videoRect.height / video.videoHeight;

                        // Position und Größe des Rahmens anpassen
                        qrBoxOverlay.style.left = `${(xMin * scaleX) + (videoRect.left - containerRect.left)}px`;
                        qrBoxOverlay.style.top = `${(yMin * scaleY) + (videoRect.top - containerRect.top)}px`;
                        qrBoxOverlay.style.width = `${(xMax - xMin) * scaleX}px`;
                        qrBoxOverlay.style.height = `${(yMax - yMin) * scaleY}px`;
                        qrBoxOverlay.style.display = 'block';
                    }
                }
            }

            // Callback bei Scan-Fehler (wird bei jedem Frame aufgerufen, in dem kein QR-Code gefunden wird)
            function onScanFailure(error) {
                // Diese Funktion bleibt leer, um ständige Fehlermeldungen in der Konsole zu vermeiden.
            }

            // Initialisierung des Scanners
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", 
                { 
                    fps: 20, // Erhöhte FPS für flüssigere Erkennung
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        return {
                            width: minEdge * 0.7,
                            height: minEdge * 0.7
                        };
                    },
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    },
                    rememberLastUsedCamera: true // Erinnert sich an die zuletzt verwendete Kamera
                }, 
                /* verbose= */ false
            );
            
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            // Verstecke den Rahmen, wenn für eine Weile kein QR-Code mehr erkannt wurde
            setInterval(() => {
                if (Date.now() - lastScanTime > cooldown) {
                    qrBoxOverlay.style.display = 'none';
                    lastScanResult = null; // Setzt den letzten Scan zurück, damit derselbe Code erneut gescannt werden kann
                }
            }, 200);
        });
    </script>

</body>
</html>
