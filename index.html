<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live QR-Code-Scanner</title>
    <style>
        /* Grundlegende Stile f√ºr die Seite */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50; /* Dunkelblauer Hintergrund */
            color: #ecf0f1; /* Helle Schriftfarbe */
        }

        h1 {
            margin-bottom: 20px;
        }

        /* Container f√ºr den Video-Feed */
        #qr-reader-container {
            position: relative;
            width: 90vw;
            max-width: 500px; /* Maximale Breite des Scanners */
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            background-color: #34495e;
        }

        /* Element, in das die Bibliothek das Video rendert */
        #qr-reader {
            width: 100%;
            border: none; /* Entfernt den Standardrahmen der Bibliothek */
        }

        /* √úberlagerung f√ºr den animierten Rahmen */
        #qr-box-overlay {
            position: absolute;
            box-sizing: border-box;
            border: 4px solid #f1c40f; /* Leuchtendes Gelb */
            box-shadow: 0 0 25px #f1c40f, inset 0 0 25px #f1c40f;
            display: none; /* Standardm√§√üig ausgeblendet */
            pointer-events: none; /* Stellt sicher, dass die √úberlagerung nicht klickbar ist */
            border-radius: 8px;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* CSS-Animation f√ºr den pulsierenden Effekt */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>

    <h1>Live QR-Code-Scanner üöÄ</h1>
    <div id="qr-reader-container">
        <div id="qr-reader"></div>
        <div id="qr-box-overlay"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const qrReaderElement = document.getElementById('qr-reader');
            const qrBoxOverlay = document.getElementById('qr-box-overlay');
            
            let lastScanTime = 0;
            const cooldown = 1000; // 1 Sekunde Cooldown zwischen den Scans

            // Diese Funktion wird aufgerufen, wenn ein QR-Code erfolgreich erkannt wird
            function onScanSuccess(decodedText, decodedResult) {
                const now = Date.now();
                if (now - lastScanTime < cooldown) {
                    return; // Ignoriert Scans innerhalb der Cooldown-Periode
                }
                lastScanTime = now;

                console.log(`Gescannter Code: ${decodedText}`);
                alert(`Erkannter QR-Code:\n${decodedText}`);

                // Die Bibliothek liefert Koordinaten des erkannten Codes
                if (decodedResult.result && decodedResult.result.points) {
                    const points = decodedResult.result.points;
                    const video = qrReaderElement.querySelector('video');

                    if (!video) return;

                    // Finde die min/max Koordinaten, um ein Rechteck zu bilden
                    const xCoords = points.map(p => p.x);
                    const yCoords = points.map(p => p.y);
                    const xMin = Math.min(...xCoords);
                    const yMin = Math.min(...yCoords);
                    const xMax = Math.max(...xCoords);
                    const yMax = Math.max(...yCoords);
                    
                    const containerRect = qrReaderElement.getBoundingClientRect();
                    const videoRect = video.getBoundingClientRect();

                    // Berechne die Skalierung, da die Videoaufl√∂sung und die Anzeigegr√∂√üe abweichen k√∂nnen
                    const scaleX = videoRect.width / video.videoWidth;
                    const scaleY = videoRect.height / video.videoHeight;
                    
                    // Berechne die Position des Videostreams innerhalb des Containers
                    const videoOffsetX = videoRect.left - containerRect.left;
                    const videoOffsetY = videoRect.top - containerRect.top;

                    // Positioniere und skaliere den gelben Rahmen genau √ºber dem QR-Code
                    qrBoxOverlay.style.left = `${(xMin * scaleX) + videoOffsetX}px`;
                    qrBoxOverlay.style.top = `${(yMin * scaleY) + videoOffsetY}px`;
                    qrBoxOverlay.style.width = `${(xMax - xMin) * scaleX}px`;
                    qrBoxOverlay.style.height = `${(yMax - yMin) * scaleY}px`;
                    
                    // Mache den Rahmen sichtbar
                    qrBoxOverlay.style.display = 'block';
                }
            }

            // Diese Funktion wird bei jedem Frame aufgerufen, in dem kein QR-Code gefunden wird.
            function onScanFailure(error) {
                // Leer lassen, um Konsolen-Spam zu vermeiden
            }

            // Initialisierung und Konfiguration des Scanners
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", 
                { 
                    fps: 15, // Frames pro Sekunde f√ºr das Scannen
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        return { width: minEdge * 0.8, height: minEdge * 0.8 }; // Scanbereich ist 80% des Viewports
                    },
                    rememberLastUsedCamera: true, // Erinnert sich an die Kameraauswahl
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] // Erzwingt die Kameranutzung
                }, 
                /* verbose= */ false
            );
            
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            // Verstecke den Rahmen wieder, wenn eine Zeit lang nichts gescannt wurde
            setInterval(() => {
                if (Date.now() - lastScanTime > cooldown) {
                    qrBoxOverlay.style.display = 'none';
                }
            }, 500);
        });
    </script>

</body>
</html>
